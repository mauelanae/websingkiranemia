<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Nilai Hb</title>
    <link href="./output.css" rel="stylesheet">
</head>

<body class="flex items-center justify-center min-h-screen">
  <div class="bg-white p-8 w-full max-w-md">
    <h1 class="text-2xl font-bold mb-6 text-center">Input Tes HB</h1>
    <form id="hbForm" class="space-y-4">
      <div>
        <label for="tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Pemeriksaan</label>
        <input type="date" id="tanggal" name="tanggal"
          class="w-full bg-[#E4E4E4] rounded-full px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
          required>
      </div>
      <div>
        <label for="nilai_hb" class="block text-sm font-medium text-gray-700 mb-2">Nilai HB (g/dL)</label>
        <input type="number" step="0.1" id="nilai_hb" name="nilai_hb"
          class="w-full bg-[#E4E4E4] rounded-full px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
          required>
      </div>
      <div class="flex justify-center">
        <button type="button" id="cekStatus"
          class="bg-[#01A4C0] text-white text-sm md:text-lg px-26 md:px-10 py-2 rounded-full font-bold hover:bg-[#0188a3] transition-all"">Lihat
          Status HB</button>
      </div>
      <hr class="my-4">
    </form>
    <div id="statusSection" class="mt-2 hidden">
      <label class="">Status HB</label>
      <div class="mb-4 bg-[#E4E4E4] rounded-3xl px-3 py-8">
        <div class="mb-2">
          <span class="font-semibold">Status HB:</span>
          <span id="statusHb" class="ml-2"></span>
        </div>
        <div>
          <span class="font-semibold">Tips:</span>
          <span id="tipsHb" class="ml-2"></span>
        </div>
      </div>
      <div class="flex justify-center">
        <button type="button" id="kirimPeneliti"
          class="bg-[#01A4C0] text-white text-sm md:text-lg px-26 md:px-10 py-2 rounded-full font-bold hover:bg-[#0188a3] transition-all">Kirim
          HB ke
          Peneliti</button>
      </div>
    </div>
  </div>
  <!-- Popup Konfirmasi -->
  <div id="popupKonfirmasi" class="fixed inset-0 bg-black bg-opacity-40 items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full text-center">
      <h2 class="text-lg font-bold mb-4">Konfirmasi</h2>
      <p class="mb-6">Apakah Anda yakin ingin mengirim data HB ke peneliti?</p>
      <div class="flex justify-center gap-4">
        <button id="btnBatal" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Batal</button>
        <button id="btnKonfirmasi" class="px-4 py-2 rounded bg-[#01A4C0] text-white hover:bg-[#0188a3]">Kirim</button>
      </div>
    </div>
  </div>
  <!-- Popup Sukses -->
  <div id="popupSukses" class="fixed inset-0 bg-black bg-opacity-40 items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full text-center">
      <h2 class="text-lg font-bold mb-4">Sukses</h2>
      <p class="mb-6">Data HB berhasil dikirim ke peneliti.</p>
      <button id="btnTutupSukses" class="px-4 py-2 rounded bg-[#01A4C0] text-white hover:bg-[#0188a3]">Tutup</button>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjTDV7aEs2X9WEBqBQ5ydqVVqVn5F5Lbk",
      authDomain: "singkiranemia.firebaseapp.com",
      databaseURL: "https://singkiranemia-default-rtdb.firebaseio.com",
      projectId: "singkiranemia",
      storageBucket: "singkiranemia.firebasestorage.app",
      messagingSenderId: "1084321478178",
      appId: "1:1084321478178:web:041668eddda59b3e46bc7b",
      measurementId: "G-SMPDBPQW6E"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function getHbStatus(nilaiHb) {
      let status = "";
      let tips = [];

      if (nilaiHb > 11) {
        status = "Normal";
        tips = [
          "Tetap konsumsi makanan tinggi zat besi seperti daging merah, hati ayam, bayam, dan kacang-kacangan.",
          "Lanjutkan konsumsi tablet tambah darah sesuai anjuran bidan/dokter kandungan.",
          "Hindari konsumsi teh/kopi berdekatan dengan waktu makan agar penyerapan zat besi tidak terganggu.",
          "Lakukan pemeriksaan Hb secara berkala."
        ];
      } else if (nilaiHb >= 10) {
        status = "Anemia Ringan";
        tips = [
          "Tingkatkan konsumsi makanan sumber zat besi (hati, daging, sayur berwarna hijau tua).",
          "Tambahkan sumber vitamin C (jeruk, tomat) agar penyerapan zat besi lebih optimal.",
          "Minum tablet tambah darah setiap hari (1 tablet/hari).",
          "Istirahat cukup dan hindari aktivitas berat.",
          "Perhatikan cara tepat meminum tablet tambah darah anda.",
          "Konsultasi rutin ke fasilitas kesehatan."
        ];
      } else if (nilaiHb >= 7) {
        status = "Anemia Sedang";
        tips = [
          "Segera konsultasi ke bidan/dokter kandungan untuk mendapat penanganan lebih lanjut.",
          "Konsumsi tablet tambah darah 2 kali sehari (jika disarankan tenaga kesehatan).",
          "Perbanyak asupan zat besi hewani (daging, ikan, telur).",
          "Sertakan buah tinggi vitamin C di setiap makan.",
          "Pertimbangkan suplemen zat besi tambahan jika diresepkan.",
          "Perhatikan cara tepat meminum tablet tambah darah anda."
        ];
      } else {
        status = "Anemia Berat";
        tips = [
          "Segera ke fasilitas kesehatan untuk evaluasi dan tindakan medis lebih lanjut.",
          "Kemungkinan perlu penanganan lanjut (misalnya transfusi darah).",
          "Ikuti semua saran tenaga medis, dan pastikan istirahat total jika disarankan.",
          "Perhatikan tanda bahaya kehamilan dan konsultasi intensif ke bidan / dokter kandungan."
        ];
      }

      return { status, tips };
    }

    let hbDataCache = null;

    // Tampilkan status HB saat tombol "Lihat Status HB" diklik
    document.getElementById("cekStatus").addEventListener("click", function () {
      const tanggal = document.getElementById("tanggal").value;
      const nilaiHb = parseFloat(document.getElementById("nilai_hb").value);

      if (!tanggal || isNaN(nilaiHb)) {
        alert("Silakan isi tanggal dan nilai HB terlebih dahulu.");
        return;
      }

      const statusResult = getHbStatus(nilaiHb);
      document.getElementById("statusHb").textContent = statusResult.status;

      // Tampilkan tips dalam bentuk list
      if (Array.isArray(statusResult.tips)) {
        const ul = document.createElement("ul");
        ul.className = "list-disc ml-5";
        statusResult.tips.forEach(function (tip) {
          const li = document.createElement("li");
          li.textContent = tip;
          ul.appendChild(li);
        });
        document.getElementById("tipsHb").innerHTML = "";
        document.getElementById("tipsHb").appendChild(ul);
      } else {
        document.getElementById("tipsHb").textContent = statusResult.tips;
      }

      document.getElementById("statusSection").classList.remove("hidden");

      hbDataCache = {
        tanggal: tanggal,
        nilaiHb: nilaiHb,
        status: statusResult.status,
        tips: statusResult.tips
      };
    });

    // Tampilkan popup konfirmasi saat tombol "Kirim HB ke Peneliti" diklik
    document.getElementById("kirimPeneliti").addEventListener("click", function () {
      if (!hbDataCache) {
        alert("Silakan cek status HB terlebih dahulu.");
        return;
      }
      document.getElementById("popupKonfirmasi").classList.remove("hidden");
      document.getElementById("popupKonfirmasi").classList.add("flex");
    });

    // Tombol batal pada popup konfirmasi
    document.getElementById("btnBatal").addEventListener("click", function () {
      document.getElementById("popupKonfirmasi").classList.add("hidden");
      document.getElementById("popupKonfirmasi").classList.remove("flex");
    });

    // Tombol konfirmasi pada popup konfirmasi
    document.getElementById("btnKonfirmasi").addEventListener("click", function () {
      const userId = localStorage.getItem("userId");
      if (!userId) {
        alert("Data ibu hamil tidak ditemukan. Harap isi formulir ibu hamil terlebih dahulu.");
        return;
      }
      if (!hbDataCache) {
        alert("Data Hb belum lengkap. Silakan isi terlebih dahulu.");
        return;
      }
      push(ref(db, 'users/' + userId + '/hb'), hbDataCache)
        .then(() => {
          document.getElementById("popupKonfirmasi").classList.add("hidden");
          document.getElementById("popupKonfirmasi").classList.remove("flex");
          document.getElementById("popupSukses").classList.remove("hidden");
          document.getElementById("popupSukses").classList.add("flex");
        })
        .catch(error => {
          alert("Gagal menyimpan data Hb: " + error.message);
        });
    });

    // Tombol tutup pada popup sukses
    document.getElementById("btnTutupSukses").addEventListener("click", function () {
      document.getElementById("popupSukses").classList.add("hidden");
      document.getElementById("popupSukses").classList.remove("flex");
      document.getElementById("hbForm").reset();
      document.getElementById("statusSection").classList.add("hidden");
      hbDataCache = null;
      window.location.href = "/index.html";
    });
  </script>
</body>

</html>
